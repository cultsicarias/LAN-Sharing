<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flash Transfer v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .file-item:hover { transform: translateY(-2px); box-shadow: 0 4px_12px rgba(0,0,0,0.1); }
        .progress-bar { transition: width 0.1s linear; }
        .drag-over { border-style: dashed; border-color: #3b82f6; background-color: #eff6ff; }
        .switch-field { display: flex; overflow: hidden; }
        .switch-field input { position: absolute !important; clip: rect(0, 0, 0, 0); height: 1px; width: 1px; border: 0; overflow: hidden; }
        .switch-field label { background-color: #e5e7eb; color: rgba(0, 0, 0, 0.6); font-size: 14px; line-height: 1; text-align: center; padding: 8px 16px; margin-right: -1px; border: 1px solid rgba(0, 0, 0, 0.2); box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px rgba(255, 255, 255, 0.1); transition: all 0.1s ease-in-out; }
        .switch-field label:hover { cursor: pointer; }
        .switch-field input:checked + label { background-color: #3b82f6; color: white; box-shadow: none; }
        .switch-field label:first-of-type { border-radius: 4px 0 0 4px; }
        .switch-field label:last-of-type { border-radius: 0 4px 4px 0; }
        .dark .switch-field label { background-color: #4b5563; color: #d1d5db; border-color: #6b7280; }
        .dark .switch-field input:checked + label { background-color: #2563eb; }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div class="container mx-auto max-w-4xl p-4 sm:p-6 md:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-gray-900 dark:text-white">Flash Transfer <span class="text-blue-500">v2</span></h1>
            <p class="text-lg text-gray-600 dark:text-gray-400 mt-2">Share files with transfer speeds and broadcasting.</p>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-2 gap-8">
           
            <div id="upload-container" class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-200 dark:border-gray-700">
                <h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-white">Send a File</h2>
                <form id="uploadForm" class="space-y-4">
                    <div id="drop-zone" class="flex justify-center items-center w-full h-48 border-2 border-gray-300 dark:border-gray-600 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                        </div>
                        <input id="fileInput" type="file" class="hidden">
                    </div>

                   
                    <div class="flex items-center justify-center pt-2">
                        <div class="switch-field">
                            <input type="radio" id="upload-mode-permanent" name="upload-mode" value="permanent" checked/>
                            <label for="upload-mode-permanent">Permanent</label>
                            <input type="radio" id="upload-mode-broadcast" name="upload-mode" value="broadcast" />
                            <label for="upload-mode-broadcast">Broadcast</label>
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-4 focus:ring-blue-300 dark:focus:ring-blue-800 transition-all duration-300 shadow-md">
                        Upload File
                    </button>
                </form>
                <div id="upload-progress-container" class="w-full mt-4 hidden">
                    <div class="flex justify-between mb-1">
                        <span class="text-base font-medium text-blue-700 dark:text-white">Uploading...</span>
                        
                        <span id="transfer-speed" class="text-sm font-medium text-blue-700 dark:text-white">0 Mbps</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                        <div id="upload-progress-bar" class="bg-blue-600 h-2.5 rounded-full progress-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div id="status" class="mt-4 text-center text-sm font-medium"></div>
            </div>

        
            <div class="space-y-8">
                
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-white">Broadcast Files</h2>
                    <div id="broadcastFileList" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                        <p id="no-broadcast-files-message" class="text-gray-500 dark:text-gray-400">No broadcast files available.</p>
                    </div>
                </div>

              
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6 border border-gray-200 dark:border-gray-700">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-900 dark:text-white">Permanent Files</h2>
                    <div id="fileList" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                        <p id="no-files-message" class="text-gray-500 dark:text-gray-400">No permanent files available.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
       
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const statusDiv = document.getElementById('status');
        const dropZone = document.getElementById('drop-zone');
        
        const progressContainer = document.getElementById('upload-progress-container');
        const progressBar = document.getElementById('upload-progress-bar');
        const transferSpeedSpan = document.getElementById('transfer-speed');
        
        const fileListDiv = document.getElementById('fileList');
        const noFilesMessage = document.getElementById('no-files-message');
        const broadcastFileListDiv = document.getElementById('broadcastFileList');
        const noBroadcastFilesMessage = document.getElementById('no-broadcast-files-message');
        
        let fileToUpload = null;

   
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                fileToUpload = e.dataTransfer.files[0];
                updateDropZoneText(fileToUpload.name);
            }
        });
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                fileToUpload = fileInput.files[0];
                updateDropZoneText(fileToUpload.name);
            }
        });

        function updateDropZoneText(filename) {
            dropZone.querySelector('p').innerHTML = `<span class="font-semibold text-blue-600">${filename}</span> selected.`;
        }

        
        uploadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!fileToUpload) {
                showStatus('Please select a file first.', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileToUpload);

        
            const uploadMode = document.querySelector('input[name="upload-mode"]:checked').value;
            const endpoint = uploadMode === 'broadcast' ? '/upload-broadcast' : '/upload';
            const fullUrl = `${window.location.origin}${endpoint}`;

            const xhr = new XMLHttpRequest();

           
            let lastLoaded = 0;
            let lastTime = Date.now();
            xhr.upload.addEventListener('progress', (event) => {
                if (event.lengthComputable) {
                    const percentComplete = (event.loaded / event.total) * 100;
                    progressBar.style.width = percentComplete + '%';

                    const currentTime = Date.now();
                    const timeDiff = (currentTime - lastTime) / 1000; 
                    const bytesDiff = event.loaded - lastLoaded;

                    if (timeDiff > 0.5) { 
                        const speedBps = bytesDiff / timeDiff; 
                        const speedMbps = (speedBps * 8) / (1024 * 1024); 
                        transferSpeedSpan.textContent = `${speedMbps.toFixed(2)} Mbps`;
                        lastLoaded = event.loaded;
                        lastTime = currentTime;
                    }
                }
            });

            xhr.addEventListener('load', () => {
                if (xhr.status === 200) {
                    showStatus(`File ${uploadMode === 'broadcast' ? 'broadcasted' : 'uploaded'} successfully!`, 'success');
                    fetchAllFiles(); 
                    resetUploadForm();
                } else {
                    showStatus(`Upload failed: ${xhr.responseText}`, 'error');
                }
                finalizeUploadUI();
            });

            xhr.addEventListener('error', () => {
                showStatus('An error occurred during the transfer.', 'error');
                finalizeUploadUI();
            });

            xhr.open('POST', fullUrl, true);
            
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            transferSpeedSpan.textContent = '0 Mbps';
            showStatus('Starting upload...', 'loading');
            
            xhr.send(formData);
        });

        function resetUploadForm() {
            fileToUpload = null;
            uploadForm.reset(); 
            updateDropZoneText('Click to upload');
        }
        
        function finalizeUploadUI() {
            progressBar.style.width = '100%';
            setTimeout(() => {
               progressContainer.classList.add('hidden');
               progressBar.style.width = '0%';
            }, 2000);
        }

        
        function createFileElement(file, type) {
            const fileElement = document.createElement('a');
            const fileUrl = `${window.location.origin}/${type}/${encodeURIComponent(file)}`;
            fileElement.href = fileUrl;
            fileElement.download = file;
            fileElement.className = 'file-item bg-gray-50 dark:bg-gray-700 p-3 rounded-lg flex items-center justify-between shadow-sm hover:shadow-md transition-all duration-300';
            fileElement.innerHTML = `
                <span class="truncate font-medium text-gray-700 dark:text-gray-300 pr-2">${file}</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
            `;
            return fileElement;
        }

        async function fetchAndDisplayFiles(endpoint, listDiv, noFilesMsg, type) {
            try {
                const fullUrl = `${window.location.origin}${endpoint}`;
                const response = await fetch(fullUrl);
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                const files = await response.json();
                
                listDiv.innerHTML = ''; 

                if (files.length === 0) {
                    listDiv.appendChild(noFilesMsg);
                    noFilesMsg.classList.remove('hidden');
                } else {
                    noFilesMsg.classList.add('hidden');
                    files.forEach(file => {
                        listDiv.appendChild(createFileElement(file, type));
                    });
                }
            } catch (error) {
                console.error(`Error fetching ${type} files:`, error);
                showStatus(`Could not fetch ${type} file list.`, 'error');
            }
        }
        
        function fetchAllFiles() {
            fetchAndDisplayFiles('/files', fileListDiv, noFilesMessage, 'uploads');
            fetchAndDisplayFiles('/files-broadcast', broadcastFileListDiv, noBroadcastFilesMessage, 'broadcast');
        }

       
        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = 'mt-4 text-center text-sm font-medium'; 
            const colorClasses = {
                success: 'text-green-600 dark:text-green-400',
                error: 'text-red-600 dark:text-red-400',
                loading: 'text-gray-600 dark:text-gray-400'
            };
            const classesToAdd = (colorClasses[type] || colorClasses.loading).split(' ');
            statusDiv.classList.add(...classesToAdd);
        }

        
        document.addEventListener('DOMContentLoaded', fetchAllFiles);
    </script>
</body>
</html>


